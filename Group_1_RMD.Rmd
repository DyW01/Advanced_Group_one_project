---
title: "Exam"
author: 'Group_1 : Aditi, Shwesin, Theo, Akash and Daanyaal'
date: "2022-09-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.



#As a group we have devided the tasks between each other
#through each others mistakes we have learnt
#The road is visible in script DYW_Exam_Script
#Now we have produced a final recipe to tidy this specific data
#---------------------- Refined script and steps -----------------------------#


**Packages**

-   [`Reference - ways to load and install packages`](https://statsandr.com/blog/an-efficient-way-to-install-and-load-r-packages/){.uri}

```{r Install and load packages - Alternative 1}

#List of packages
#install.packages(c(tidyverse, ggplot2, here, pacman))
library(tidyverse)
library(here)
library(ggplot2)
library(fs)
library(knitr)
#pacman::p_load(ggplot2, tidyverse, here, fs)

```



**Directory and Environment**

-   `Ctrl+Shift+A` to reformat code in the code chunks/R script file
-   `Ctrl+Shift+M` for `%>%`

```{r }
#getwd()  - current directory
#here()   - current directory
#setwd()  - change working directory
#ls()     - files in environment
#remove(ls()) - clears environment - OBS!
#dir()    - files in current directory
#dir_tree(here()) - draws a tree of the current directory
```

**File**

-   Loading file into the environment
-   Viewing file + summary stats + missing
-   Data manipulation

```{r Load file, include=FALSE}

#Step 2 - Reading the text files, make sure directory is correct
#Load file into work environment
#Separate columns using delimiter ("tab" - \t)
#Set working directory setwd() if things are not working

here()
setwd("C:/Users/asi006/Downloads/RMED/Advanced_Group_one_project/Data")
nontidy_data <- read_delim("exam_nontidy.txt", delim = "\t")
tidy_data <- nontidy_data
join_data <- read_delim("exam_joindata.txt", delim = "\t")


```

```{r Viewing file, }

#view(tidy_data) #not advised for large data structures
head(tidy_data)
glimpse(tidy_data)

#Provides summary statistics - missing, complete, n and sd
#<https://www.rdocumentation.org/packages/skimr/versions/2.1.4>
skimr::skim(tidy_data)

#Graph showing frequency of missing for each variable
naniar::gg_miss_var((tidy_data))

#column names
colnames(tidy_data)

```


```{r Data wrangling and tidying}

#Day 6 Oppgave
#The Pipe setup of multiple tidy mutations and transformation
#----------------Will yield to the tidiest data -------------------#


tidy_data <- tidy_data %>%   #Assign our transformed data to object
  pivot_wider(names_from = `feature type`,
              values_from = feature_value,) %>%  #Eradicating duplicates by pivot
  rename(age = `1.age`) %>%        #Renaming unfortunate column name
  separate(date,                  #Better visualization be separating column
           into = c("year", "month"),
           sep = "-") %>%
  mutate(age = as.numeric(age)) %>%         #Defining column content as numerical
  mutate(across(.cols = age, ~ round(., digits = 3))) %>% #Keeping to three decimal across all columns
  mutate(race =                         #Abbreviating the content in column
           case_when(
             race == "black" ~ "B",
             race == "white" ~ "W",
             race == "none" ~ NA_character_
           )) %>%
  mutate(sex =
           case_when(
             sex == "female" ~ "0",
             sex == "male" ~ "1",
             sex == "none" ~ NA_character_
           )) %>%
  mutate(sex = as.factor(sex)) %>%         #Defining column as categorical
  mutate(blood_neut_pct = if_else(blood_neut_pct <= 35, "Low", "High")) %>%
  mutate(blood_cult = 100 * blood_cult / max(blood_cult, na.rm = TRUE)) %>%
  mutate(blood_cult = round(blood_cult, digits = 0)) %>% #Keeping to nearest whole number
  mutate(blood_wbc = round(blood_wbc, digits = 1)) %>%     #keeping 1 decimal
  mutate(age_agm = age * abm) %>%   #numeric column showing multiplication of age and abm
  subset(select = -c(gram, month)) %>%  #Removing excessive column
  select(id, 
         age,
         sex,
         race,
         starts_with("csf"),
         starts_with("blood"),
         everything()) %>% #Another way to keep only the columns you want
  full_join(join_data, by = ("id")) %>% #joining the join data file to the mutated tidy_data
  arrange(id) #ordering ID in ascending 


# Converts continuous "numeric" into categorical "factor" data
# This methods allows the conversion of several variables into once
factor_cols <-  c("sex", "year", "abm", "race", "blood_neut_pct")
tidy_data[, factor_cols] <-
  lapply(tidy_data[, factor_cols] , factor)


```


```{r Saving file}

#Check path/ directory before saving
#write_csv(tidy_data, file = "exam_tidy.csv")

```


```{r Missing data after tidying the data}

skimr::skim(tidy_data) #Check the complete rate - all rows have an id 
naniar::gg_miss_var((tidy_data)) # Graphing the missing data
#The variables "blood_cult" and "csf_cult" have the most missing data (give information on growth of bacteria in the blood and CSF respectively)

```


```{r Day 6 Tasks I}

#frequency/count for each subgroup 
tidy_data %>%
  group_by(race, sex) %>%
  count() %>% 
  rename(total = n)

#Table
table(tidy_data$race, tidy_data$sex) %>% 
  head()


```

```{r Day 6 Tasks II, warning = FALSE}

# Mean/Min/Max/SD of white blood count in blood (blood_wbc) by sex and race

#blood_wbc_sex <-
  tidy_data %>%
  group_by(sex) %>%
  summarise(
    max_blood_wbc = max(blood_wbc, na.rm = T),
    min_blood_wbc = min(blood_wbc, na.rm = T),
    mean_blood_wbc = mean(blood_wbc, na.rm = T),
    sd_blood_wbc = sd(blood_wbc, na.rm = T)
  )

#blood_wbc_race <-
  tidy_data %>%
  group_by(race) %>%
  summarise(
    max_blood_wbc = max(blood_wbc, na.rm = T),
    min_blood_wbc = min(blood_wbc, na.rm = T),
    mean_blood_wbc = mean(blood_wbc, na.rm = T),
    sd_blood_wbc = sd(blood_wbc, na.rm = T)
  ) 

#blood_wbc_race_sex <-
tidy_data %>%
  filter(!is.na(race) & !is.na(sex)) %>% #removing cases with missing data for gender and sex
  group_by(race, sex) %>%
  summarise(
    max_blood_wbc = max(blood_wbc, na.rm = T),
    min_blood_wbc = min(blood_wbc, na.rm = T),
    mean_blood_wbc = mean(blood_wbc, na.rm = T),
    sd_blood_wbc = sd(blood_wbc, na.rm = T),
    .groups = 'drop') # Adding this to remove the warning : https://stackoverflow.com/questions/62140483/how-to-interpret-dplyr-message-summarise-regrouping-output-by-x-override
```

```{r Day 6 Tasks III}

# Mean/Min/Max/SD of csf_prot (Protein in CSF) for people with :

#   blood_cult == 0 
tidy_data %>%
  filter(blood_cult == 0) %>% 
  summarise(
    max_csf_prot = max(csf_prot, na.rm = T),
    min_csf_prot = min(csf_prot, na.rm = T),
    mean_csf_prot = mean(csf_prot, na.rm = T),
    sd_csf_prot = sd(csf_prot, na.rm = T)
  )

#   females
tidy_data %>%
  filter(sex == 0) %>% 
  summarise(
    max_csf_prot = max(csf_prot, na.rm = T),
    min_csf_prot = min(csf_prot, na.rm = T),
    mean_csf_prot = mean(csf_prot, na.rm = T),
    sd_csf_prot = sd(csf_prot, na.rm = T)
  )




#   race black and blood_gluc higher than 120
tidy_data %>%
  filter(blood_gluc >= 120 & race == "B") %>% 
  summarise(
    max_csf_prot = max(csf_prot, na.rm = T),
    min_csf_prot = min(csf_prot, na.rm = T),
    mean_csf_prot = mean(csf_prot, na.rm = T),
    sd_csf_prot = sd(csf_prot, na.rm = T)
  )


#   persons older than 45
#Since there is repetition, we decided to create a function to fo this job for us.
data_summary <- function(y) {
    max_ <- max(y, na.rm = T)
    min_ <- min(y, na.rm = T)
    mean_ <- mean(y, na.rm = T)
    sd_ <- sd(y, na.rm = T)
    data_ <- c(max_, min_, mean_, sd_)
    col_ <- c("Maximum", "Minimum", "Mean","SD")
    df_ <- tibble(col_, data_)
    return(df_)
}

#Although smart, it doesn't seem to work with the pipes. 
#Therefore, we created a new data set with the specific filters and ran that as a argument of the function.
tidy_data_age_45 <- tidy_data %>%
  filter(age >= 45) 
data_summary(tidy_data_age_45$csf_prot)

```



```{r Day 7 Tasks I}


#View as table the relation of blood_gluc grouped by sex
#blood_gluc_summary <-
  tidy_data %>%
  drop_na(sex,
          blood_gluc) %>% #remove missing values to make less messy table
  group_by(sex) %>% #Now select this as the group we check glucose for
  summarize(
    Lower = min(blood_gluc),
    #Now we use summarize (NOT summary) to spesify what we look for
    Average = mean(blood_gluc),
    Upper = max(blood_gluc),
    Difference = max(blood_gluc) - min(blood_gluc)
  ) %>%
  arrange(Average)


#Selected column summary (blood_cult, female, etc)
tidy_data %>%       #tidyverse way
  split(.$blood_cult) %>%
  map(summary) %>% 
  view()

#In order to make it for blood_cult == 0 use filter function (from Akash)
tidy_data %>%
  filter(blood_cult == 0) %>%
  map(summary)
```



```{r Day 7 }

#Does the glucose level in blood depend on sex?
#Assuming this task can be solved by plotting information in table2 ?
ggplot(tidy_data,  # define data
       aes(x = as.factor(sex), y = blood_gluc)) +  # define which columns are x and y,
  geom_boxplot()


#Does the glucose level in CSF (cerebrospinal fluid) depend on race?
csf_gluc_race_grouped <- tidy_data %>%
  filter(race == "B" | race == "W") %>%
  group_by(race)


#calculate sum of csf_gluc per race
csf_gluc_race_summary <- csf_gluc_race_grouped %>%
  summarise(sum = sum(csf_gluc, na.rm = TRUE))
csf_gluc_race_summary


#Explore your data.
#Explore and comment on the missing variables.
naniar::gg_miss_var((tidy_data))
summary(tidy_data) #R base function
skimr::skim(tidy_data) #Tidyverse way


```

```{r Day 8}

#Analyse the dataset and answer the following questions: (each person chooses one question)
#Is there a difference in the occurrence of the disease by sex? (DYW)
#assign object to select column

tidy_data_4chisq <- tidy_data %>%
  mutate(sex = as.numeric(sex)) %>% #mutating, so that it is same type as abm (R doesn't think like a statistician, so both can be numerical)
  select(abm, sex) #select the variable
#In this test, make sure both variables are same type.
chisq.test(tidy_data_4chisq$abm, tidy_data_4chisq$sex)


#----------Using regression to find time trend in the occurrence of the disease?#
#Catagorical outcome... makes it difficult
#can view the relation by looking at proportion of disease occurrence pr year
tidy_data %>%
  filter(!is.na(year)) %>%
  group_by(year) %>%
  #  summarise(prop = mean(abm, na.rm=T)) %>%
  summarise(prop = sum(abm, na.rm = T)) %>%
  ggplot(aes(x = year, y = prop)) +
  geom_col()

#Trying linear regression on frequency pr year
Time_trend1 <-
  tidy_data %>%
  group_by(year) %>%
  summarise(prop = sum(abm, na.rm = T)) %>%
  lm(prop ~ year, data = .) %>%
  broom::tidy()


```





